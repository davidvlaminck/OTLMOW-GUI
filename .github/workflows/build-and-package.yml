name: Build EXE and Inno Installer
run-name: Building an exe and setup files
on:
  push:
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: windows-latest
    env:
      PYTHON: 'C:\hostedtoolcache\windows\Python\3.13.2\x64\python.exe'
      RELEASE_DIR: '${{ github.workspace }}\\LatestReleaseMulti'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13.2'

      - name: Locate signtool and add to PATH
        uses: KamaranL/add-signtool-action@v1
        id: signtool

      - name: Show located signtool path
        env:
          SIGTOOL_PATH: ${{ steps.signtool.outputs.signtool-x64 }}
        run: |
          Write-Host "SignTool: $env:SIGTOOL_PATH"
        shell: pwsh

      - name: Restore PFX from secret
        env:
          SIGN_PFX_BASE64: ${{ secrets.SIGN_PFX_BASE64 }}
          SIGN_PFX_PASSWORD: ${{ secrets.SIGN_PFX_PASSWORD }}
        run: |
          $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          $bytes = [System.Convert]::FromBase64String($env:SIGN_PFX_BASE64)
          [System.IO.File]::WriteAllBytes($pfxPath, $bytes)
          Write-Output "PFX written to $pfxPath"
          "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding ASCII
        shell: pwsh

      - name: Sign executable with signtool
        env:
          SIGTOOL_PATH: ${{ steps.signtool.outputs.signtool-x64 }}
          PFX_PATH: ${{ env.PFX_PATH }}
          SIGN_PFX_PASSWORD: ${{ secrets.SIGN_PFX_PASSWORD }}
        run: |
          if (-not $env:SIGTOOL_PATH) {
            Write-Error "SIGTOOL_PATH is empty. Check the previous step outputs and the action's output name."
            exit 1
          }
          Write-Host "Using SignTool: $env:SIGTOOL_PATH"
          if (-not (Test-Path -Path $env:PFX_PATH)) {
            Write-Error "PFX not found at $env:PFX_PATH"
            exit 1
          }
          $exeToSign = Join-Path '${{ github.workspace }}' 'path\to\your.exe'
          if (-not (Test-Path -Path $exeToSign)) {
            Write-Error "Executable to sign not found: $exeToSign"
            exit 1
          }
          & "$env:SIGTOOL_PATH" sign /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 /f "$env:PFX_PATH" /p "$env:SIGN_PFX_PASSWORD" "$exeToSign"
        shell: pwsh
